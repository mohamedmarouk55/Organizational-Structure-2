<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الهيكل التنظيمي - مع إمكانية الطي والتوسيع</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 8px;
        }
        .search-box {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 300px;
            font-size: 16px;
        }
        .upload-btn, .add-btn, .toggle-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-left: 10px;
        }
        .upload-btn:hover, .add-btn:hover, .toggle-btn:hover {
            background-color: #2980b9;
        }
        .org-chart {
            overflow: auto;
            padding: 20px 0;
            max-height: 70vh;
        }
        .node {
            margin: 10px 0;
            padding: 15px;
            background-color: #3498db;
            color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: relative;
            transition: all 0.3s ease;
        }
        .node:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .node-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toggle-icon {
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 20px;
            text-align: center;
        }
        .node-actions {
            display: flex;
            gap: 5px;
        }
        .edit-btn, .delete-btn, .add-child-btn {
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .edit-btn {
            background-color: #f39c12;
            color: white;
        }
        .delete-btn {
            background-color: #e74c3c;
            color: white;
        }
        .add-child-btn {
            background-color: #27ae60;
            color: white;
        }
        .node-details {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 10px;
        }
        .children {
            padding-right: 30px;
            border-right: 2px dashed #bdc3c7;
            margin-right: 15px;
            margin-top: 10px;
            transition: all 0.3s ease;
        }
        .children.hidden {
            display: none;
        }
        .level-0 {
            background-color: #e74c3c;
            font-size: 18px;
        }
        .level-1 {
            background-color: #3498db;
        }
        .level-2 {
            background-color: #2ecc71;
        }
        .level-3 {
            background-color: #f39c12;
        }
        .level-4 {
            background-color: #9b59b6;
        }
        .level-5 {
            background-color: #1abc9c;
        }
        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .close {
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        .confirm-dialog {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .confirm-content {
            background-color: white;
            margin: 20% auto;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            text-align: center;
        }
        .no-children {
            font-style: italic;
            color: #7f8c8d;
            text-align: center;
            padding: 20px;
            display: none;
        }
        .employee-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
        }
        .employee-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .employee-item:hover {
            background-color: #f0f0f0;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background-color: #ecf0f1;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        .tab.active {
            background-color: #3498db;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #7f8c8d;
        }
        .upload-area {
            border: 2px dashed #3498db;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            border-radius: 8px;
            cursor: pointer;
            background-color: #f8f9fa;
        }
        .upload-area:hover {
            background-color: #e9ecef;
        }
        .file-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #e8f4fd;
            border-radius: 4px;
            display: none;
        }
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>الهيكل التنظيمي - مع إمكانية الطي والتوسيع</h1>
        
        <div class="upload-area" id="uploadArea">
            <h3>اسحب وأفلت ملف Excel هنا</h3>
            <p>أو</p>
            <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">اختر ملف Excel</button>
            <div class="file-info" id="fileInfo"></div>
        </div>
        
        <div id="statusMessage" class="status-message" style="display: none;"></div>
        
        <div class="stats" id="orgStats" style="display: none;">
            <div class="stat-item">
                <div class="stat-number" id="totalEmployees">0</div>
                <div class="stat-label">إجمالي الموظفين</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalLevels">0</div>
                <div class="stat-label">عدد المستويات</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="topLevelCount">0</div>
                <div class="stat-label">الموظفين في المستوى الأعلى</div>
            </div>
        </div>
        
        <div class="controls">
            <input type="text" class="search-box" placeholder="البحث عن موظف..." id="searchInput">
            <div>
                <button class="toggle-btn" id="collapseAllBtn">طي الكل</button>
                <button class="toggle-btn" id="expandAllBtn">توسيع الكل</button>
                <button class="add-btn" id="addRootBtn">إضافة موظف جديد</button>
            </div>
        </div>
        
        <div class="org-chart" id="orgChart">
            <div class="loading">يرجى رفع ملف Excel لعرض الهيكل التنظيمي</div>
        </div>
    </div>

    <!-- Modal لإضافة/تعديل الموظف -->
    <div class="modal" id="employeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">إضافة موظف جديد</h2>
                <span class="close" id="closeModal">&times;</span>
            </div>
            <form id="employeeForm">
                <input type="hidden" id="employeeId">
                <input type="hidden" id="parentId">
                <input type="hidden" id="level">
                
                <div class="form-group">
                    <label for="employeeName">الاسم كاملاً باللغة العربية *</label>
                    <input type="text" id="employeeName" required>
                </div>
                
                <div class="form-group">
                    <label for="jobTitle">المسمى الوظيفي *</label>
                    <input type="text" id="jobTitle" required>
                </div>
                
                <div class="form-group">
                    <label for="directManager">المدير المباشر</label>
                    <div style="position: relative;">
                        <input type="text" id="directManager" readonly>
                        <button type="button" id="selectManagerBtn" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); padding: 5px 10px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">اختيار</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="nationality">الجنسية</label>
                    <input type="text" id="nationality">
                </div>
                
                <div class="form-group">
                    <label for="gender">الجنس</label>
                    <select id="gender">
                        <option value="ذكر">ذكر</option>
                        <option value="أنثى">أنثى</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="department">القسم</label>
                    <input type="text" id="department">
                </div>
                
                <div class="form-group">
                    <label for="location">الموقع</label>
                    <input type="text" id="location">
                </div>
                
                <div class="form-group">
                    <label for="joinDate">تاريخ الانضمام</label>
                    <input type="date" id="joinDate">
                </div>
                
                <div class="form-group">
                    <label for="experience">سنوات خبرة العمل</label>
                    <input type="text" id="experience">
                </div>
                
                <div class="form-group">
                    <label for="basicSalary">الراتب الأساسي</label>
                    <input type="number" id="basicSalary" min="0">
                </div>
                
                <div class="form-group">
                    <label for="housingAllowance">بدل سكن</label>
                    <input type="number" id="housingAllowance" min="0">
                </div>
                
                <div class="form-group">
                    <label for="transportationAllowance">بدل مواصلات</label>
                    <input type="number" id="transportationAllowance" min="0">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal لاختيار المدير المباشر -->
    <div class="modal" id="managerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>اختيار المدير المباشر</h2>
                <span class="close" id="closeManagerModal">&times;</span>
            </div>
            <div class="form-group">
                <input type="text" id="managerSearch" placeholder="البحث عن مدير..." class="search-box">
            </div>
            <div class="employee-list" id="managersList" style="max-height: 400px;">
                <!-- سيتم تعبئة قائمة المديرين هنا -->
            </div>
        </div>
    </div>

    <!-- مربع حوار التأكيد للحذف -->
    <div class="confirm-dialog" id="confirmDelete">
        <div class="confirm-content">
            <h3>تأكيد الحذف</h3>
            <p>هل أنت متأكد أنك تريد حذف هذا الموظف وجميع الموظفين التابعين له؟</p>
            <div class="form-actions">
                <button class="btn btn-secondary" id="cancelDelete">إلغاء</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">حذف</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // المتغيرات العامة
        let employees = [];
        let orgData = null;
        let currentManagerId = null;
        let isAllExpanded = true;

        // معالجة رفع الملف
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        
        // معالجة السحب والإفلات
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#e9ecef';
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#f8f9fa';
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#f8f9fa';
            
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }
        
        function handleFile(file) {
            const fileInfo = document.getElementById('fileInfo');
            const statusMessage = document.getElementById('statusMessage');
            
            fileInfo.innerHTML = `<strong>اسم الملف:</strong> ${file.name}<br><strong>الحجم:</strong> ${formatFileSize(file.size)}`;
            fileInfo.style.display = 'block';
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // الحصول على أول ورقة في الملف
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // تحويل البيانات إلى JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // معالجة البيانات
                    processExcelData(jsonData);
                    
                    // عرض رسالة نجاح
                    statusMessage.textContent = 'تم تحميل الملف بنجاح!';
                    statusMessage.className = 'status-message success';
                    statusMessage.style.display = 'block';
                    
                    // إخفاء رسالة النجاح بعد 5 ثوانٍ
                    setTimeout(() => {
                        statusMessage.style.display = 'none';
                    }, 5000);
                    
                } catch (error) {
                    console.error('خطأ في معالجة الملف:', error);
                    statusMessage.textContent = 'حدث خطأ أثناء معالجة الملف. يرجى التأكد من أن الملف بصيغة Excel وصحيح.';
                    statusMessage.className = 'status-message error';
                    statusMessage.style.display = 'block';
                }
            };
            
            reader.onerror = function() {
                statusMessage.textContent = 'حدث خطأ أثناء قراءة الملف.';
                statusMessage.className = 'status-message error';
                statusMessage.style.display = 'block';
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function processExcelData(data) {
            // البحث عن رؤوس الأعمدة
            let headers = [];
            let startRow = 0;
            
            for (let i = 0; i < data.length; i++) {
                if (Array.isArray(data[i]) && data[i].length > 0) {
                    // البحث عن الصف الذي يحتوي على "الرقم الوظيفي" و"الاسم كاملاً باللغة العربية" وغيرها
                    if (data[i].some(cell => typeof cell === 'string' && cell.includes('الرقم الوظيفي')) &&
                        data[i].some(cell => typeof cell === 'string' && cell.includes('الاسم كاملاً باللغة العربية'))) {
                        headers = data[i].filter(cell => cell !== undefined && cell !== null);
                        startRow = i + 1;
                        break;
                    }
                }
            }
            
            if (headers.length === 0) {
                throw new Error('لم يتم العثور على رؤوس الأعمدة المناسبة في ملف Excel');
            }
            
            // تعيين فهرس كل عمود
            const columnIndices = {};
            headers.forEach((header, index) => {
                if (typeof header === 'string') {
                    if (header.includes('الرقم الوظيفي')) columnIndices.id = index;
                    else if (header.includes('الاسم كاملاً باللغة العربية')) columnIndices.name = index;
                    else if (header.includes('المسمى الوظيفي')) columnIndices.jobTitle = index;
                    else if (header.includes('المدير المباشر')) columnIndices.directManager = index;
                    else if (header.includes('الجنسية')) columnIndices.nationality = index;
                    else if (header.includes('الجنس')) columnIndices.gender = index;
                    else if (header.includes('القسم')) columnIndices.department = index;
                    else if (header.includes('الموقع')) columnIndices.location = index;
                    else if (header.includes('تاريخ الانضمام')) columnIndices.joinDate = index;
                    else if (header.includes('سنوات خبرة العمل')) columnIndices.experience = index;
                    else if (header.includes('الراتب الأساسي')) columnIndices.basicSalary = index;
                    else if (header.includes('بدل سكن')) columnIndices.housingAllowance = index;
                    else if (header.includes('بدل مواصلات')) columnIndices.transportationAllowance = index;
                    else if (header.includes('كامل الراتب')) columnIndices.totalSalary = index;
                }
            });
            
            // التحقق من وجود الأعمدة الأساسية
            if (!columnIndices.name || !columnIndices.jobTitle) {
                throw new Error('لم يتم العثور على الأعمدة الأساسية (الاسم، المسمى الوظيفي) في ملف Excel');
            }
            
            // معالجة بيانات الموظفين
            employees = [];
            for (let i = startRow; i < data.length; i++) {
                const row = data[i];
                if (!Array.isArray(row) || row.length === 0) continue;
                
                // تخطي الصفوف الفارغة أو التي لا تحتوي على اسم الموظف
                if (!row[columnIndices.name] || row[columnIndices.name] === '') continue;
                
                const employee = {
                    id: row[columnIndices.id] ? row[columnIndices.id].toString() : generateId(),
                    name: row[columnIndices.name] ? row[columnIndices.name].toString() : '',
                    jobTitle: row[columnIndices.jobTitle] ? row[columnIndices.jobTitle].toString() : '',
                    directManager: row[columnIndices.directManager] ? row[columnIndices.directManager].toString() : '',
                    nationality: row[columnIndices.nationality] ? row[columnIndices.nationality].toString() : '',
                    gender: row[columnIndices.gender] ? row[columnIndices.gender].toString() : 'ذكر',
                    department: row[columnIndices.department] ? row[columnIndices.department].toString() : '',
                    location: row[columnIndices.location] ? row[columnIndices.location].toString() : '',
                    joinDate: row[columnIndices.joinDate] ? formatDate(row[columnIndices.joinDate]) : '',
                    experience: row[columnIndices.experience] ? row[columnIndices.experience].toString() : '',
                    basicSalary: row[columnIndices.basicSalary] ? parseFloat(row[columnIndices.basicSalary]) || 0 : 0,
                    housingAllowance: row[columnIndices.housingAllowance] ? parseFloat(row[columnIndices.housingAllowance]) || 0 : 0,
                    transportationAllowance: row[columnIndices.transportationAllowance] ? parseFloat(row[columnIndices.transportationAllowance]) || 0 : 0,
                    totalSalary: row[columnIndices.totalSalary] ? parseFloat(row[columnIndices.totalSalary]) || 0 : 0,
                    children: [],
                    isExpanded: true // إضافة حالة التوسيع/الطي
                };
                
                // إذا لم يتم تحديد الراتب الإجمالي، نحسبه
                if (employee.totalSalary === 0) {
                    employee.totalSalary = employee.basicSalary + employee.housingAllowance + employee.transportationAllowance;
                }
                
                employees.push(employee);
            }
            
            // بناء الهيكل التنظيمي
            buildOrgStructure();
            updateStats();
            renderOrgChart();
            
            // عرض إحصائيات الهيكل
            document.getElementById('orgStats').style.display = 'flex';
        }
        
        function formatDate(date) {
            if (typeof date === 'string') {
                return date;
            } else if (date instanceof Date) {
                return date.toISOString().split('T')[0];
            } else {
                // محاولة تحليل التاريخ إذا كان رقمًا (تنسيق Excel)
                try {
                    const excelDate = new Date(Math.round((date - 25569) * 86400 * 1000));
                    return excelDate.toISOString().split('T')[0];
                } catch (e) {
                    return '';
                }
            }
        }
        
        // بناء الهيكل التنظيمي من البيانات
        function buildOrgStructure() {
            // إنشاء خريطة للموظفين
            const employeeMap = new Map();
            employees.forEach(emp => {
                // إذا لم يكن هناك ID، ننشئ واحدًا
                if (!emp.id) {
                    emp.id = generateId();
                }
                employeeMap.set(emp.id, {...emp, children: [], isExpanded: true});
            });
            
            // ربط الموظفين بمديريهم
            employees.forEach(emp => {
                if (emp.directManager && emp.directManager.trim() !== '' && emp.directManager !== 'ــــــــــــــــــــــــــــــــــــــــــــــ') {
                    // البحث عن المدير بالاسم
                    const manager = employees.find(m => m.name === emp.directManager);
                    if (manager) {
                        const managerNode = employeeMap.get(manager.id);
                        if (managerNode) {
                            managerNode.children.push(employeeMap.get(emp.id));
                        }
                    }
                }
            });
            
            // العثور على الجذر (الموظفين الذين ليس لديهم مدير أو مديرهم فارغ)
            const rootEmployees = employees.filter(emp => 
                !emp.directManager || 
                emp.directManager.trim() === '' || 
                emp.directManager === 'ــــــــــــــــــــــــــــــــــــــــــــــ'
            );
            
            if (rootEmployees.length > 0) {
                orgData = employeeMap.get(rootEmployees[0].id);
            } else if (employees.length > 0) {
                // إذا لم يتم العثور على جذر، نستخدم أول موظف
                orgData = employeeMap.get(employees[0].id);
            } else {
                // إذا لم يكن هناك موظفين، ننشئ هيكلًا فارغًا
                orgData = {
                    id: generateId(),
                    name: 'الرئيس التنفيذي',
                    jobTitle: 'رئيس تنفيذي',
                    directManager: '',
                    nationality: 'سعودي',
                    gender: 'ذكر',
                    department: 'الادارة التنفيذية',
                    location: 'الادارة التنفيذية',
                    joinDate: new Date().toISOString().split('T')[0],
                    experience: '0 سنة',
                    basicSalary: 0,
                    housingAllowance: 0,
                    transportationAllowance: 0,
                    totalSalary: 0,
                    children: [],
                    isExpanded: true
                };
            }
        }

        // دالة لعرض الهيكل التنظيمي
        function renderOrgChart() {
            const orgChart = document.getElementById('orgChart');
            if (!orgData) {
                orgChart.innerHTML = '<div class="loading">يرجى رفع ملف Excel لعرض الهيكل التنظيمي</div>';
                return;
            }
            orgChart.innerHTML = '';
            orgChart.appendChild(createNodeElement(orgData, 0));
        }

        // دالة لإنشاء عنصر عقدة
        function createNodeElement(node, level) {
            const nodeDiv = document.createElement('div');
            nodeDiv.className = `node level-${level}`;
            nodeDiv.dataset.id = node.id;

            const nodeHeader = document.createElement('div');
            nodeHeader.className = 'node-header';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'node-title';
            
            // إضافة أيقونة الطي/التوسيع إذا كان للعقدة أطفال
            if (node.children && node.children.length > 0) {
                const toggleIcon = document.createElement('span');
                toggleIcon.className = 'toggle-icon';
                toggleIcon.innerHTML = node.isExpanded ? '▼' : '▶';
                toggleIcon.onclick = function(e) {
                    e.stopPropagation();
                    toggleNode(node.id);
                };
                titleDiv.appendChild(toggleIcon);
            }
            
            const titleText = document.createElement('span');
            titleText.innerHTML = `<strong>${node.name}</strong> - ${node.jobTitle}`;
            titleDiv.appendChild(titleText);
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'node-actions';
            
            const editBtn = document.createElement('button');
            editBtn.className = 'edit-btn';
            editBtn.textContent = 'تعديل';
            editBtn.onclick = function() { openEditModal(node); };
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = 'حذف';
            deleteBtn.onclick = function() { openDeleteConfirm(node.id); };
            
            const addChildBtn = document.createElement('button');
            addChildBtn.className = 'add-child-btn';
            addChildBtn.textContent = 'إضافة تابع';
            addChildBtn.onclick = function() { openAddModal(node); };
            
            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(deleteBtn);
            actionsDiv.appendChild(addChildBtn);
            
            nodeHeader.appendChild(titleDiv);
            nodeHeader.appendChild(actionsDiv);
            
            const nodeDetails = document.createElement('div');
            nodeDetails.className = 'node-details';
            
            let detailsHTML = `
                <div><strong>الجنسية:</strong> ${node.nationality}</div>
                <div><strong>الجنس:</strong> ${node.gender}</div>
                <div><strong>القسم:</strong> ${node.department}</div>
                <div><strong>الموقع:</strong> ${node.location}</div>
            `;
            
            if (node.joinDate) {
                detailsHTML += `<div><strong>تاريخ الانضمام:</strong> ${node.joinDate}</div>`;
            }
            
            if (node.experience) {
                detailsHTML += `<div><strong>سنوات الخبرة:</strong> ${node.experience}</div>`;
            }
            
            if (node.totalSalary) {
                detailsHTML += `<div><strong>الراتب الإجمالي:</strong> ${node.totalSalary.toLocaleString()} ريال</div>`;
            }
            
            nodeDetails.innerHTML = detailsHTML;
            
            nodeDiv.appendChild(nodeHeader);
            nodeDiv.appendChild(nodeDetails);
            
            if (node.children && node.children.length > 0) {
                const childrenDiv = document.createElement('div');
                childrenDiv.className = `children ${node.isExpanded ? '' : 'hidden'}`;
                
                // فرز الأطفال أبجديًا حسب الاسم
                const sortedChildren = [...node.children].sort((a, b) => a.name.localeCompare(b.name, 'ar'));
                
                sortedChildren.forEach(child => {
                    childrenDiv.appendChild(createNodeElement(child, level + 1));
                });
                
                nodeDiv.appendChild(childrenDiv);
            } else {
                const noChildrenDiv = document.createElement('div');
                noChildrenDiv.className = 'no-children';
                noChildrenDiv.textContent = 'لا يوجد موظفين تابعين';
                nodeDiv.appendChild(noChildrenDiv);
            }
            
            return nodeDiv;
        }

        // دالة للطي أو التوسيع
        function toggleNode(nodeId) {
            function findAndToggle(node, targetId) {
                if (node.id === targetId) {
                    node.isExpanded = !node.isExpanded;
                    return true;
                }
                
                if (node.children) {
                    for (let child of node.children) {
                        if (findAndToggle(child, targetId)) {
                            return true;
                        }
                    }
                }
                
                return false;
            }
            
            findAndToggle(orgData, nodeId);
            renderOrgChart();
        }

        // دالة للطي الكل
        function collapseAll() {
            function collapseNode(node) {
                node.isExpanded = false;
                if (node.children) {
                    node.children.forEach(child => collapseNode(child));
                }
            }
            
            if (orgData) {
                collapseNode(orgData);
                isAllExpanded = false;
                renderOrgChart();
            }
        }

        // دالة للتوسيع الكل
        function expandAll() {
            function expandNode(node) {
                node.isExpanded = true;
                if (node.children) {
                    node.children.forEach(child => expandNode(child));
                }
            }
            
            if (orgData) {
                expandNode(orgData);
                isAllExpanded = true;
                renderOrgChart();
            }
        }

        // دالة لتحديث الإحصائيات
        function updateStats() {
            if (!orgData) return;
            
            // حساب إجمالي الموظفين
            function countEmployees(node) {
                let count = 1; // العد يشمل العقدة الحالية
                if (node.children) {
                    node.children.forEach(child => {
                        count += countEmployees(child);
                    });
                }
                return count;
            }
            
            // حساب أقصى عمق
            function getMaxDepth(node, currentDepth = 0) {
                let maxDepth = currentDepth;
                if (node.children) {
                    node.children.forEach(child => {
                        const childDepth = getMaxDepth(child, currentDepth + 1);
                        if (childDepth > maxDepth) {
                            maxDepth = childDepth;
                        }
                    });
                }
                return maxDepth;
            }
            
            // حساب عدد الموظفين في المستوى الأعلى (الأطفال المباشرين للجذر)
            const topLevelCount = orgData.children ? orgData.children.length : 0;
            
            // تحديث الإحصائيات
            document.getElementById('totalEmployees').textContent = countEmployees(orgData);
            document.getElementById('totalLevels').textContent = getMaxDepth(orgData) + 1; // +1 لأننا نبدأ من 0
            document.getElementById('topLevelCount').textContent = topLevelCount;
        }

        // دالة للبحث في الهيكل التنظيمي
        function searchOrgChart() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (!searchTerm) {
                renderOrgChart();
                return;
            }
            
            function searchNode(node, term) {
                if (node.name.toLowerCase().includes(term) || 
                    node.jobTitle.toLowerCase().includes(term) ||
                    (node.department && node.department.toLowerCase().includes(term))) {
                    return true;
                }
                
                if (node.children) {
                    for (let child of node.children) {
                        if (searchNode(child, term)) {
                            return true;
                        }
                    }
                }
                
                return false;
            }
            
            function filterNode(node, term) {
                if (searchNode(node, term)) {
                    const filteredNode = {...node};
                    if (filteredNode.children) {
                        filteredNode.children = filteredNode.children
                            .map(child => filterNode(child, term))
                            .filter(child => child !== null);
                    }
                    return filteredNode;
                }
                return null;
            }
            
            const filteredData = filterNode(orgData, searchTerm);
            if (filteredData) {
                const orgChart = document.getElementById('orgChart');
                orgChart.innerHTML = '';
                orgChart.appendChild(createNodeElement(filteredData, 0));
            } else {
                document.getElementById('orgChart').innerHTML = '<div style="text-align: center; padding: 20px;">لا توجد نتائج مطابقة للبحث</div>';
            }
        }

        // دالة لفتح نموذج الإضافة
        function openAddModal(parentNode) {
            document.getElementById('modalTitle').textContent = 'إضافة موظف جديد';
            document.getElementById('employeeForm').reset();
            document.getElementById('employeeId').value = generateId();
            document.getElementById('parentId').value = parentNode ? parentNode.id : '';
            document.getElementById('level').value = parentNode ? getLevel(parentNode) + 1 : 0;
            document.getElementById('directManager').value = parentNode ? parentNode.name : '';
            
            document.getElementById('employeeModal').style.display = 'block';
        }

        // دالة لفتح نموذج التعديل
        function openEditModal(node) {
            document.getElementById('modalTitle').textContent = 'تعديل بيانات الموظف';
            document.getElementById('employeeId').value = node.id;
            document.getElementById('parentId').value = '';
            document.getElementById('level').value = getLevel(node);
            document.getElementById('employeeName').value = node.name;
            document.getElementById('jobTitle').value = node.jobTitle;
            document.getElementById('directManager').value = node.directManager;
            document.getElementById('nationality').value = node.nationality;
            document.getElementById('gender').value = node.gender;
            document.getElementById('department').value = node.department;
            document.getElementById('location').value = node.location;
            document.getElementById('joinDate').value = node.joinDate;
            document.getElementById('experience').value = node.experience;
            document.getElementById('basicSalary').value = node.basicSalary;
            document.getElementById('housingAllowance').value = node.housingAllowance;
            document.getElementById('transportationAllowance').value = node.transportationAllowance;
            
            document.getElementById('employeeModal').style.display = 'block';
        }

        // دالة لفتح نموذج اختيار المدير المباشر
        function openManagerModal() {
            currentManagerId = document.getElementById('employeeId').value;
            document.getElementById('managerSearch').value = '';
            renderManagersList();
            document.getElementById('managerModal').style.display = 'block';
        }

        // دالة لعرض قائمة المديرين
        function renderManagersList() {
            const managersList = document.getElementById('managersList');
            managersList.innerHTML = '';
            
            // استبعاد الموظف الحالي من قائمة المديرين لتجنب التعيين الذاتي
            const filteredEmployees = employees.filter(emp => emp.id !== currentManagerId);
            const sortedEmployees = [...filteredEmployees].sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            
            sortedEmployees.forEach(employee => {
                const managerItem = document.createElement('div');
                managerItem.className = 'employee-item';
                managerItem.innerHTML = `
                    <strong>${employee.name}</strong> - ${employee.jobTitle}
                    <div style="font-size: 12px; color: #7f8c8d;">
                        ${employee.department || 'لا يوجد قسم'}
                    </div>
                `;
                managerItem.onclick = function() {
                    document.getElementById('directManager').value = employee.name;
                    document.getElementById('managerModal').style.display = 'none';
                };
                managersList.appendChild(managerItem);
            });
        }

        // دالة للبحث في قائمة المديرين
        function searchManagersList() {
            const searchTerm = document.getElementById('managerSearch').value.toLowerCase();
            const managersList = document.getElementById('managersList');
            managersList.innerHTML = '';
            
            const filteredEmployees = employees.filter(emp => 
                emp.id !== currentManagerId && (
                    emp.name.toLowerCase().includes(searchTerm) || 
                    emp.jobTitle.toLowerCase().includes(searchTerm) ||
                    (emp.department && emp.department.toLowerCase().includes(searchTerm))
                )
            );
            
            const sortedEmployees = [...filteredEmployees].sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            
            if (sortedEmployees.length === 0) {
                managersList.innerHTML = '<div style="text-align: center; padding: 20px; color: #7f8c8d;">لا توجد نتائج مطابقة للبحث</div>';
                return;
            }
            
            sortedEmployees.forEach(employee => {
                const managerItem = document.createElement('div');
                managerItem.className = 'employee-item';
                managerItem.innerHTML = `
                    <strong>${employee.name}</strong> - ${employee.jobTitle}
                    <div style="font-size: 12px; color: #7f8c8d;">
                        ${employee.department || 'لا يوجد قسم'}
                    </div>
                `;
                managerItem.onclick = function() {
                    document.getElementById('directManager').value = employee.name;
                    document.getElementById('managerModal').style.display = 'none';
                };
                managersList.appendChild(managerItem);
            });
        }

        // دالة لفتح مربع حوار التأكيد للحذف
        function openDeleteConfirm(employeeId) {
            window.currentDeleteId = employeeId;
            document.getElementById('confirmDelete').style.display = 'block';
        }

        // دالة للحصول على مستوى العقدة
        function getLevel(node) {
            let level = 0;
            let current = node;
            while (current.parent) {
                level++;
                current = current.parent;
            }
            return level;
        }

        // دالة لتوليد معرف فريد
        function generateId() {
            return Date.now().toString() + Math.floor(Math.random() * 1000).toString();
        }

        // معالجة إرسال النموذج
        document.getElementById('employeeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('employeeId').value;
            const parentId = document.getElementById('parentId').value;
            const level = document.getElementById('level').value;
            const name = document.getElementById('employeeName').value;
            const jobTitle = document.getElementById('jobTitle').value;
            const directManager = document.getElementById('directManager').value;
            const nationality = document.getElementById('nationality').value;
            const gender = document.getElementById('gender').value;
            const department = document.getElementById('department').value;
            const location = document.getElementById('location').value;
            const joinDate = document.getElementById('joinDate').value;
            const experience = document.getElementById('experience').value;
            const basicSalary = parseInt(document.getElementById('basicSalary').value) || 0;
            const housingAllowance = parseInt(document.getElementById('housingAllowance').value) || 0;
            const transportationAllowance = parseInt(document.getElementById('transportationAllowance').value) || 0;
            
            // حساب الراتب الإجمالي
            const totalSalary = basicSalary + housingAllowance + transportationAllowance;
            
            const newEmployee = {
                id,
                name,
                jobTitle,
                directManager,
                nationality,
                gender,
                department,
                location,
                joinDate,
                experience,
                basicSalary,
                housingAllowance,
                transportationAllowance,
                totalSalary,
                children: [],
                isExpanded: true
            };
            
            // إضافة الموظف إلى قاعدة البيانات
            employees.push(newEmployee);
            
            if (parentId) {
                // إضافة كتابع
                function findAndAddChild(node, targetId, child) {
                    if (node.id === targetId) {
                        node.children.push(child);
                        return true;
                    }
                    
                    if (node.children) {
                        for (let childNode of node.children) {
                            if (findAndAddChild(childNode, targetId, child)) {
                                return true;
                            }
                        }
                    }
                    
                    return false;
                }
                
                findAndAddChild(orgData, parentId, newEmployee);
            } else {
                // إذا لم يكن هناك parentId، فهذا تعديل على الموظف الحالي
                function findAndEditNode(node, targetId) {
                    if (node.id === targetId) {
                        node.name = name;
                        node.jobTitle = jobTitle;
                        node.directManager = directManager;
                        node.nationality = nationality;
                        node.gender = gender;
                        node.department = department;
                        node.location = location;
                        node.joinDate = joinDate;
                        node.experience = experience;
                        node.basicSalary = basicSalary;
                        node.housingAllowance = housingAllowance;
                        node.transportationAllowance = transportationAllowance;
                        node.totalSalary = totalSalary;
                        return true;
                    }
                    
                    if (node.children) {
                        for (let childNode of node.children) {
                            if (findAndEditNode(childNode, targetId)) {
                                return true;
                            }
                        }
                    }
                    
                    return false;
                }
                
                findAndEditNode(orgData, id);
            }
            
            // إعادة بناء الهيكل وعرضه
            updateStats();
            renderOrgChart();
            
            document.getElementById('employeeModal').style.display = 'none';
        });

        // إغلاق النموذج
        document.getElementById('closeModal').onclick = function() {
            document.getElementById('employeeModal').style.display = 'none';
        };

        document.getElementById('cancelBtn').onclick = function() {
            document.getElementById('employeeModal').style.display = 'none';
        };

        // إغلاق مربع حوار التأكيد
        document.getElementById('cancelDelete').onclick = function() {
            document.getElementById('confirmDelete').style.display = 'none';
        };

        // تأكيد الحذف
        document.getElementById('confirmDeleteBtn').onclick = function() {
            const employeeId = window.currentDeleteId;
            
            // حذف الموظف من قاعدة البيانات
            employees = employees.filter(emp => emp.id !== employeeId);
            
            function findAndDeleteNode(node, targetId) {
                if (node.children) {
                    for (let i = 0; i < node.children.length; i++) {
                        if (node.children[i].id === targetId) {
                            node.children.splice(i, 1);
                            return true;
                        }
                        
                        if (findAndDeleteNode(node.children[i], targetId)) {
                            return true;
                        }
                    }
                }
                
                return false;
            }
            
            if (orgData.id === employeeId) {
                // حذف العقدة الجذرية - ننشئ واحدة جديدة فارغة
                orgData = {
                    id: generateId(),
                    name: 'رئيس تنفيذي',
                    jobTitle: 'رئيس تنفيذي',
                    directManager: '',
                    nationality: 'سعودي',
                    gender: 'ذكر',
                    department: 'الادارة التنفيذية',
                    location: 'الادارة التنفيذية',
                    joinDate: new Date().toISOString().split('T')[0],
                    experience: '0 سنة',
                    basicSalary: 0,
                    housingAllowance: 0,
                    transportationAllowance: 0,
                    totalSalary: 0,
                    children: [],
                    isExpanded: true
                };
            } else {
                findAndDeleteNode(orgData, employeeId);
            }
            
            // إعادة بناء الهيكل وعرضه
            updateStats();
            renderOrgChart();
            
            document.getElementById('confirmDelete').style.display = 'none';
        };

        // البحث عند الكتابة
        document.getElementById('searchInput').addEventListener('input', searchOrgChart);
        document.getElementById('managerSearch').addEventListener('input', searchManagersList);

        // إضافة موظف جذري جديد
        document.getElementById('addRootBtn').onclick = function() {
            openAddModal(null);
        };

        // فتح نموذج اختيار المدير
        document.getElementById('selectManagerBtn').onclick = function() {
            openManagerModal();
        };

        // أزرار الطي والتوسيع
        document.getElementById('collapseAllBtn').onclick = function() {
            collapseAll();
        };

        document.getElementById('expandAllBtn').onclick = function() {
            expandAll();
        };

        // إغلاق المودال عند النقر خارجه
        window.onclick = function(event) {
            const modal = document.getElementById('employeeModal');
            const managerModal = document.getElementById('managerModal');
            const confirmDelete = document.getElementById('confirmDelete');
            
            if (event.target == modal) {
                modal.style.display = 'none';
            }
            
            if (event.target == managerModal) {
                managerModal.style.display = 'none';
            }
            
            if (event.target == confirmDelete) {
                confirmDelete.style.display = 'none';
            }
        };

        // عرض رسالة ترحيبية عند التحميل الأول
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('orgChart').innerHTML = '<div class="loading">يرجى رفع ملف Excel لعرض الهيكل التنظيمي</div>';
        });
    </script>
</body>
</html>